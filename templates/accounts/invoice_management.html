<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management - Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #dc3545;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 60px;
            --transition-speed: 0.3s;
        }

        /* Light Mode Variables */
        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.1);
            --table-header: #e9ecef;
            --table-row-even: #f8f9fa;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-glass: rgba(26, 26, 26, 0.9);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.5);
            --table-header: #2a2a2a;
            --table-row-even: #1f1f1f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: all var(--transition-speed) ease;
        }

        /* Include same navbar and sidebar styles from task_management.html */
        .navbar {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            z-index: 1000;
            transition: left var(--transition-speed) ease;
        }

        .navbar.sidebar-collapsed {
            left: var(--sidebar-collapsed-width);
        }

        .navbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all var(--transition-speed) ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-secondary);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all var(--transition-speed) ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            z-index: 1001;
            transition: width var(--transition-speed) ease;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all var(--transition-speed) ease;
            cursor: pointer;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-item.active {
            background: var(--accent-color);
            color: white;
        }

        .menu-item i {
            min-width: 20px;
            margin-right: 1rem;
            text-align: center;
        }

        .menu-text {
            white-space: nowrap;
            opacity: 1;
            transition: opacity var(--transition-speed) ease;
        }

        .sidebar.collapsed .menu-text {
            opacity: 0;
        }

        .sidebar.collapsed .sidebar-logo {
            font-size: 1rem;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 80px;
            padding: 2rem;
            min-height: calc(100vh - 80px);
            transition: margin-left var(--transition-speed) ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: var(--sidebar-collapsed-width);
        }

        .page-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px var(--shadow);
        }

        .filters-section {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-speed) ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .invoices-table-container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .invoices-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoices-table th {
            background: var(--table-header);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        .invoices-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .invoices-table tr:nth-child(even) {
            background: var(--table-row-even);
        }

        .invoices-table tr:hover {
            background: var(--bg-secondary);
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .status-pending { background: #ffc107; color: #212529; }
        .status-partial { background: #fd7e14; }
        .status-completed { background: #28a745; }
        .status-overdue { background: #dc3545; }

        .amount-badge {
            background: #28a745;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .balance-badge {
            background: #17a2b8;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: all var(--transition-speed) ease;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-payment {
            background: #28a745;
            color: white;
        }        .btn-delete {
            background: var(--accent-color);
            color: white;
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal and responsive styles similar to task_management.html */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px var(--shadow);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color var(--transition-speed) ease;
        }

        .close-modal:hover {
            color: var(--accent-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-speed) ease;
        }        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-input[type="file"] {
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .form-input[type="file"]:hover {
            border-color: var(--accent-color);
            background: rgba(220, 53, 69, 0.05);
        }

        .form-input[type="file"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .detail-grid {
            display: grid;
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-value {
            color: var(--text-secondary);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
        }

        .pagination a, .pagination span {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all var(--transition-speed) ease;
        }

        .pagination a:hover {
            background: var(--accent-color);
            color: white;
        }

        .pagination .current {
            background: var(--accent-color);
            color: white;
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            z-index: 3000;
            box-shadow: 0 10px 30px var(--shadow);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid var(--accent-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .navbar {
                left: 0;
                padding: 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
                z-index: 2000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .invoices-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .invoices-table {
                min-width: 700px;
            }

            .invoices-table th,
            .invoices-table td {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .action-btn {
                padding: 0.4rem;
                margin-right: 0.25rem;
            }

            .page-header {
                padding: 1.5rem 1rem;
            }

            .modal-content {
                width: 95%;
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">TEXVO</div>
        </div>
        <nav class="sidebar-menu">
            <a href="{% url 'accounts:admin_dashboard' %}" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="{% url 'accounts:user_management' %}" class="menu-item">
                <i class="fas fa-users"></i>
                <span class="menu-text">User Management</span>
            </a>
            <a href="{% url 'accounts:task_management' %}" class="menu-item">
                <i class="fas fa-tasks"></i>
                <span class="menu-text">Tasks</span>
            </a>
            <a href="{% url 'accounts:invoice_management' %}" class="menu-item active">
                <i class="fas fa-file-invoice-dollar"></i>
                <span class="menu-text">Invoices</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-database"></i>
                <span class="menu-text">Calender</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-shield-alt"></i>
                <span class="menu-text">Security</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-tools"></i>
                <span class="menu-text">Maintenance</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-bell"></i>
                <span class="menu-text">Notifications</span>
            </a>
        </nav>
    </div>

    <nav class="navbar" id="navbar">
        <div class="navbar-content">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">Invoice Management</div>
            </div>
            <div class="navbar-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-info">
                    <span>{{ user.username }}</span>
                </div>
                <a href="{% url 'accounts:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <main class="main-content" id="mainContent">
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-file-invoice-dollar"></i> Invoice Management</h1>
                    <p>Manage payments and invoices for completed tasks</p>
                </div>
                <button class="filter-btn" onclick="createInvoice()" style="background: #28a745;">
                    <i class="fas fa-plus"></i>
                    Create Invoice
                </button>
            </div>
            <div style="margin-top: 1rem;">
                <span class="status-badge status-pending">Total Invoices: {{ total_invoices }}</span>
            </div>
        </div>

        <div class="filters-section">
            <form method="GET" class="filters-grid">
                <div class="filter-group">
                    <label for="search">Search Invoices</label>
                    <input type="text" id="search" name="search" value="{{ search_query }}" 
                           placeholder="Search by invoice, task, client..." class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label for="status">Filter by Payment Status</label>
                    <select id="status" name="status" class="filter-input">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="client">Filter by Client</label>
                    <select id="client" name="client" class="filter-input">
                        <option value="">All Clients</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}" {% if client_filter == client.id|stringformat:"s" %}selected{% endif %}>
                                {{ client.first_name }} {{ client.last_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <button type="submit" class="filter-btn">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                </div>
            </form>
        </div>

        <div class="invoices-table-container">
            <table class="invoices-table">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Task & Module</th>
                        <th>Client</th>
                        <th>Amount Due</th>
                        <th>Payment Status</th>
                        <th>Deadline</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: var(--accent-color);">{{ invoice.invoice_number }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ invoice.task.task_code }}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: var(--text-primary);">{{ invoice.task.client.first_name }} {{ invoice.task.client.last_name }}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.2rem;">{{ invoice.task.module_name }}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600;">{{ invoice.task.client.first_name }} {{ invoice.task.client.last_name }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ invoice.task.client.username }}</div>
                        </td>                        <td>
                            <div>
                                <span class="amount-badge">{{ invoice.task.currency_symbol }}{{ invoice.amount_due }}</span>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.2rem;">
                                    Currency: {{ invoice.task.currency }}
                                </div>
                            </div>
                            {% if invoice.amount_paid > 0 %}
                                <div style="margin-top: 0.5rem;">
                                    <span class="balance-badge">Paid: {{ invoice.task.currency_symbol }}{{ invoice.amount_paid }}</span>
                                </div>
                                <div class="progress-bar">
                                    {% widthratio invoice.amount_paid invoice.amount_due 100 as payment_percent %}
                                    <div class="progress-fill" style="width: {{ payment_percent }}%;"></div>
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.2rem; text-align: center;">
                                    {{ payment_percent }}% paid
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ invoice.payment_status|lower }}">
                                {{ invoice.get_payment_status_display }}
                            </span>
                        </td>
                        <td>
                            <div>{{ invoice.task.deadline|date:"M d, Y" }}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ invoice.task.deadline|date:"H:i" }}</div>
                        </td>                        <td>
                            <button class="action-btn btn-view" title="View Details" onclick="viewInvoice({{ invoice.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-payment" title="Update Payment" onclick="updatePayment({{ invoice.id }})">
                                <i class="fas fa-dollar-sign"></i>
                            </button>
                            <button class="action-btn" title="Resend Invoice" onclick="resendInvoice({{ invoice.id }})" style="background: #17a2b8; color: white;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button class="action-btn btn-delete" title="Delete Invoice" onclick="deleteInvoice({{ invoice.id }}, '{{ invoice.invoice_number }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-file-invoice-dollar" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            No invoices found matching your criteria.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if invoices.has_other_pages %}
        <div class="pagination">
            {% if invoices.has_previous %}
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">&laquo; First</a>
                <a href="?page={{ invoices.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">&lsaquo; Previous</a>
            {% endif %}

            <span class="current">
                Page {{ invoices.number }} of {{ invoices.paginator.num_pages }}
            </span>

            {% if invoices.has_next %}
                <a href="?page={{ invoices.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">Next &rsaquo;</a>
                <a href="?page={{ invoices.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if client_filter %}&client={{ client_filter }}{% endif %}">Last &raquo;</a>
            {% endif %}
        </div>
        {% endif %}

        <!-- Create Invoice Modal -->
        <div id="createInvoiceModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-plus"></i> Create New Invoice</h2>
                    <span class="close-modal" onclick="closeModal('createInvoiceModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="createInvoiceForm">
                        <div class="form-group">
                            <label>Select Task: <span style="color: var(--accent-color);">*</span></label>
                            <select name="task" class="form-input" required id="taskSelect">
                                <option value="">Select Task</option>
                            </select>
                        </div>                        <div class="form-group">
                            <label>Amount Due (<span id="currencySymbol">₹</span>): <span style="color: var(--accent-color);">*</span></label>
                            <input type="number" name="amount_due" class="form-input" required placeholder="Enter amount" min="0" step="0.01" id="amountDue">
                        </div><div class="form-group">
                            <label>Notes:</label>
                            <textarea name="notes" class="form-input" rows="3" placeholder="Enter any additional notes..."></textarea>
                        </div>
                        <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 15px; margin: 15px 0;">
                            <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                <i class="fas fa-envelope"></i>
                                <strong>Auto Email:</strong> An invoice email with payment button will be automatically sent to the client's email address.
                            </p>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="filter-btn" onclick="closeModal('createInvoiceModal')">Cancel</button>
                            <button type="submit" class="filter-btn" style="background: #28a745;">Create Invoice</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Invoice Detail Modal -->
        <div id="invoiceDetailModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-info-circle"></i> Invoice Details</h2>
                    <span class="close-modal" onclick="closeModal('invoiceDetailModal')">&times;</span>
                </div>
                <div class="modal-body" id="invoiceDetailContent">
                    <!-- Invoice details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Update Payment Modal -->
        <div id="updatePaymentModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-dollar-sign"></i> Update Payment</h2>
                    <span class="close-modal" onclick="closeModal('updatePaymentModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="updatePaymentForm">
                        <input type="hidden" id="paymentInvoiceId" name="invoice_id">
                        <div class="form-group">
                            <label>Invoice Number:</label>
                            <input type="text" id="paymentInvoiceNumber" class="form-input" disabled>
                        </div>                        <div class="form-group">
                            <label>Amount Due:</label>
                            <input type="text" id="paymentAmountDue" class="form-input" disabled>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid: <span style="color: var(--accent-color);">*</span></label>
                            <input type="number" name="amount_paid" class="form-input" required min="0" step="0.01" id="paymentAmountPaid">
                        </div>                        <div class="form-group">
                            <label>Payment Status:</label>
                            <select name="payment_status" class="form-input" id="paymentStatus">
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Receipt:</label>
                            <input type="file" name="payment_receipt" class="form-input" accept=".jpg,.jpeg,.png,.gif,.pdf" id="paymentReceipt">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i>
                                Upload payment receipt (Images: JPG, PNG, GIF | Documents: PDF | Max: 5MB)
                            </div>
                            <div id="currentReceiptInfo" style="margin-top: 0.75rem; display: none;">
                                <div style="background: rgba(40, 167, 69, 0.1); border: 1px solid rgba(40, 167, 69, 0.3); border-radius: 8px; padding: 12px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div>
                                            <i class="fas fa-file-check" style="color: #28a745; margin-right: 8px;"></i>
                                            <span style="color: #28a745; font-weight: 600;">Current Receipt:</span>
                                            <span id="currentReceiptName" style="color: var(--text-primary); margin-left: 5px;"></span>
                                        </div>
                                        <a id="currentReceiptLink" href="#" target="_blank" style="color: #28a745; text-decoration: none; font-weight: 600;">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Notes:</label>
                            <textarea name="notes" class="form-input" rows="3" id="paymentNotes"></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="filter-btn" onclick="closeModal('updatePaymentModal')">Cancel</button>
                            <button type="submit" class="filter-btn" style="background: #28a745;">Update Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Success/Error Toast -->
        <div id="toast" class="toast" style="display: none;">
            <div id="toastMessage"></div>
        </div>

        <script>
            // Theme Toggle
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const themeIcon = themeToggle.querySelector('i');

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            themeToggle.addEventListener('click', () => {
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });

            function updateThemeIcon(theme) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Sidebar Toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const navbar = document.getElementById('navbar');
            const mainContent = document.getElementById('mainContent');

            sidebarToggle.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('mobile-open');
                } else {
                    sidebar.classList.toggle('collapsed');
                    navbar.classList.toggle('sidebar-collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                    
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                }
            });            // Mobile responsiveness
            function handleMobileLayout() {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    sidebar.classList.remove('collapsed');
                    navbar.classList.remove('sidebar-collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                } else {
                    sidebar.classList.remove('mobile-open');
                }
            }

            // Invoice Management Functions
            let availableTasks = [];

            // Function to load available tasks for invoice creation
            function loadAvailableTasks() {
                // This would typically be loaded from the server
                // For now, we'll simulate with the tasks that don't have invoices
                fetch('/admin/api/available-tasks/')
                    .then(response => response.json())
                    .then(tasks => {
                        availableTasks = tasks;
                        populateTaskSelect();
                    })
                    .catch(error => {
                        console.error('Error loading tasks:', error);
                        showToast('Error loading available tasks', 'error');
                    });
            }

            // Populate task select dropdown
            function populateTaskSelect() {
                const taskSelect = document.getElementById('taskSelect');
                if (!taskSelect) return;

                taskSelect.innerHTML = '<option value="">Select a task to create invoice...</option>';
                
                availableTasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.task_code} - ${task.module_name} (${task.client_name})`;
                    option.setAttribute('data-task-code', task.task_code);
                    option.setAttribute('data-client', task.client_name);
                    option.setAttribute('data-module', task.module_name);
                    option.setAttribute('data-price', task.quoted_price);
                    option.setAttribute('data-currency', task.currency);
                    option.setAttribute('data-currency-symbol', task.currency_symbol);
                    taskSelect.appendChild(option);
                });
            }

            // Update task information when a task is selected
            function updateTaskInfo() {
                const taskSelect = document.getElementById('taskSelect');
                const taskInfoPanel = document.getElementById('taskInfoPanel');
                const selectedOption = taskSelect.options[taskSelect.selectedIndex];

                if (taskSelect.value && selectedOption) {
                    // Show task info panel
                    taskInfoPanel.style.display = 'block';

                    // Update task details
                    document.getElementById('taskCode').textContent = selectedOption.getAttribute('data-task-code') || '-';
                    document.getElementById('taskClient').textContent = selectedOption.getAttribute('data-client') || '-';
                    document.getElementById('taskModule').textContent = selectedOption.getAttribute('data-module') || '-';
                    document.getElementById('taskPrice').textContent = `${selectedOption.getAttribute('data-currency-symbol')}${selectedOption.getAttribute('data-price')}` || '-';
                    document.getElementById('taskCurrency').textContent = selectedOption.getAttribute('data-currency') || '-';

                    // Update currency field
                    const currencyField = document.getElementById('invoiceCurrency');
                    const currencySymbol = document.getElementById('currencySymbol');
                    const amountField = document.getElementById('amountDue');

                    if (currencyField) {
                        currencyField.value = selectedOption.getAttribute('data-currency') || 'INR';
                    }

                    if (currencySymbol) {
                        currencySymbol.textContent = selectedOption.getAttribute('data-currency-symbol') || '₹';
                    }

                    // Auto-fill amount with quoted price
                    if (amountField) {
                        amountField.value = selectedOption.getAttribute('data-price') || '';
                    }
                } else {
                    // Hide task info panel
                    taskInfoPanel.style.display = 'none';
                    
                    // Reset fields
                    document.getElementById('invoiceCurrency').value = '';
                    document.getElementById('currencySymbol').textContent = '₹';
                    document.getElementById('amountDue').value = '';
                }
            }

            // Create Invoice Modal
            function createInvoice() {
                loadAvailableTasks();
                document.getElementById('createInvoiceModal').style.display = 'flex';
            }

            // View Invoice Details
            function viewInvoice(invoiceId) {
                fetch(`/admin/invoices/${invoiceId}/view/`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('invoiceDetailContent').innerHTML = html;
                        document.getElementById('invoiceDetailModal').style.display = 'flex';
                    })
                    .catch(error => {
                        console.error('Error loading invoice details:', error);
                        showToast('Error loading invoice details', 'error');
                    });
            }

            // Update Payment Modal
            function updatePayment(invoiceId) {
                // Load invoice data and show payment update modal
                fetch(`/admin/invoices/${invoiceId}/payment-data/`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('paymentInvoiceId').value = invoiceId;
                        document.getElementById('paymentInvoiceNumber').value = data.invoice_number;
                        document.getElementById('updatePaymentModal').style.display = 'flex';
                    })
                    .catch(error => {
                        console.error('Error loading payment data:', error);
                        showToast('Error loading payment information', 'error');
                    });
            }

            // Delete Invoice
            function deleteInvoice(invoiceId, invoiceNumber) {
                if (confirm(`Are you sure you want to delete invoice ${invoiceNumber}?`)) {
                    fetch(`/admin/invoices/${invoiceId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Invoice deleted successfully', 'success');
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showToast(data.message || 'Error deleting invoice', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting invoice:', error);
                        showToast('Error deleting invoice', 'error');
                    });
                }
            }

            // Resend Invoice
            function resendInvoice(invoiceId) {
                if (confirm('Are you sure you want to resend this invoice?')) {
                    fetch(`/admin/invoices/${invoiceId}/resend/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Invoice resent successfully', 'success');
                        } else {
                            showToast(data.message || 'Error resending invoice', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error resending invoice:', error);
                        showToast('Error resending invoice', 'error');
                    });
                }
            }

            // Close Modal
            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // Show Toast Message
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                toastMessage.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                const modals = ['createInvoiceModal', 'invoiceDetailModal', 'updatePaymentModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (e.target === modal) {
                        closeModal(modalId);
                    }
                });
            });

            window.addEventListener('resize', handleMobileLayout);
            handleMobileLayout();

            // Close mobile sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) &&
                    sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                }
            });            // Invoice Management Functions
            function createInvoice() {
                // Load tasks without invoices
                fetch('/accounts/admin/invoices/create/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const taskSelect = document.getElementById('taskSelect');
                    taskSelect.innerHTML = '<option value="">Select Task</option>';
                    
                    data.tasks.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.id;
                        option.textContent = `${task.task_code} - ${task.module_name} (${task.client_name})`;
                        option.dataset.quotedPrice = task.quoted_price;
                        option.dataset.currency = task.currency;
                        option.dataset.currencySymbol = task.currency_symbol;
                        option.dataset.formattedPrice = task.formatted_price;
                        taskSelect.appendChild(option);
                    });
                    
                    document.getElementById('createInvoiceModal').style.display = 'flex';
                })
                .catch(error => {
                    showToast('Error loading tasks', 'error');
                });
            }// Auto-fill amount due when task is selected
            document.getElementById('taskSelect').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const currencySymbol = document.getElementById('currencySymbol');
                const amountDue = document.getElementById('amountDue');
                
                if (selectedOption.value && selectedOption.dataset.quotedPrice) {
                    // Update amount due
                    amountDue.value = selectedOption.dataset.quotedPrice;
                    
                    // Update currency symbol if available
                    if (selectedOption.dataset.currencySymbol) {
                        currencySymbol.textContent = selectedOption.dataset.currencySymbol;
                    }
                } else {
                    // Reset to default
                    amountDue.value = '';
                    currencySymbol.textContent = '₹';
                }
            });

            function viewInvoice(invoiceId) {
                fetch(`/accounts/admin/invoices/${invoiceId}/view/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('invoiceDetailContent').innerHTML = `
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Invoice Number:</span>
                                <span class="detail-value">${data.invoice_number}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Task Code:</span>
                                <span class="detail-value">${data.task_code}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Module:</span>
                                <span class="detail-value">${data.module_name}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Client:</span>
                                <span class="detail-value">${data.client_name}</span>
                            </div>                            <div class="detail-item">
                                <span class="detail-label">Amount Due:</span>
                                <span class="detail-value">${data.formatted_amount_due}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Amount Paid:</span>
                                <span class="detail-value">${data.formatted_amount_paid || data.amount_paid}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Balance Due:</span>
                                <span class="detail-value">${data.formatted_balance_due}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Status:</span>
                                <span class="detail-value">${data.payment_status}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Progress:</span>
                                <span class="detail-value">${data.payment_percentage}%</span>
                            </div>                            <div class="detail-item">
                                <span class="detail-label">Payment Date:</span>
                                <span class="detail-value">${data.payment_date}</span>
                            </div>
                            ${data.payment_receipt_url ? `
                            <div class="detail-item">
                                <span class="detail-label">Payment Receipt:</span>
                                <span class="detail-value">
                                    <a href="${data.payment_receipt_url}" target="_blank" style="color: #28a745; text-decoration: none; font-weight: 600;">
                                        <i class="fas fa-file-download"></i> ${data.payment_receipt_name ? data.payment_receipt_name.split('/').pop() : 'Download Receipt'}
                                    </a>
                                </span>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <span class="detail-label">Task Deadline:</span>
                                <span class="detail-value">${data.task_deadline}</span>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${data.notes || 'No notes'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Created At:</span>
                                <span class="detail-value">${data.created_at}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Updated At:</span>
                                <span class="detail-value">${data.updated_at}</span>
                            </div>
                        </div>
                    `;
                    document.getElementById('invoiceDetailModal').style.display = 'flex';
                })
                .catch(error => {
                    showToast('Error loading invoice details', 'error');
                });
            }

            function updatePayment(invoiceId) {
                fetch(`/accounts/admin/invoices/${invoiceId}/payment/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())                .then(data => {
                    document.getElementById('paymentInvoiceId').value = data.id;
                    document.getElementById('paymentInvoiceNumber').value = data.invoice_number;
                    document.getElementById('paymentAmountDue').value = data.formatted_amount_due || `₹${data.amount_due}`;
                    document.getElementById('paymentAmountPaid').value = data.amount_paid;
                    document.getElementById('paymentStatus').value = data.payment_status;
                    document.getElementById('paymentNotes').value = data.notes;
                    
                    // Handle payment receipt display
                    const receiptInfo = document.getElementById('currentReceiptInfo');
                    const receiptName = document.getElementById('currentReceiptName');
                    const receiptLink = document.getElementById('currentReceiptLink');
                    
                    if (data.payment_receipt_url && data.payment_receipt_name) {
                        receiptInfo.style.display = 'block';
                        receiptName.textContent = data.payment_receipt_name.split('/').pop(); // Get filename only
                        receiptLink.href = data.payment_receipt_url;
                    } else {
                        receiptInfo.style.display = 'none';
                    }
                    
                    document.getElementById('updatePaymentModal').style.display = 'flex';
                })
                .catch(error => {
                    showToast('Error loading payment data', 'error');
                });
            }            function deleteInvoice(invoiceId, invoiceNumber) {
                if (confirm(`Are you sure you want to delete invoice "${invoiceNumber}"? This action cannot be undone.`)) {
                    fetch(`/accounts/admin/invoices/${invoiceId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken(),
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Error deleting invoice', 'error');
                    });
                }
            }            function resendInvoice(invoiceId) {
                if (confirm('Are you sure you want to resend this invoice to the client?')) {
                    // Find the button that was clicked
                    const button = event.target.closest('.action-btn');
                    const originalContent = button.innerHTML;
                    
                    // Add loading state
                    button.classList.add('btn-loading');
                    button.innerHTML = '<span class="spinner"></span>Sending...';
                    
                    fetch(`/accounts/admin/invoices/${invoiceId}/resend/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCsrfToken(),
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Error resending invoice', 'error');
                    })
                    .finally(() => {
                        // Remove loading state
                        button.classList.remove('btn-loading');
                        button.innerHTML = originalContent;
                    });
                }
            }

            // Get CSRF token
            function getCsrfToken() {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, 10) === ('csrftoken=')) {
                            cookieValue = decodeURIComponent(cookie.substring(10));
                            break;
                        }
                    }
                }
                return cookieValue;
            }            // Form submissions
            document.getElementById('createInvoiceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalContent = submitButton.innerHTML;
                
                // Add loading state
                submitButton.classList.add('btn-loading');
                submitButton.innerHTML = '<span class="spinner"></span>Creating...';
                
                const formData = new FormData(this);
                
                fetch('/accounts/admin/invoices/create/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        closeModal('createInvoiceModal');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('Error creating invoice', 'error');
                })
                .finally(() => {
                    // Remove loading state
                    submitButton.classList.remove('btn-loading');
                    submitButton.innerHTML = originalContent;
                });
            });            document.getElementById('updatePaymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalContent = submitButton.innerHTML;
                
                // Add loading state
                submitButton.classList.add('btn-loading');
                submitButton.innerHTML = '<span class="spinner"></span>Updating...';
                
                const formData = new FormData(this);
                const invoiceId = formData.get('invoice_id');
                
                fetch(`/accounts/admin/invoices/${invoiceId}/payment/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                        closeModal('updatePaymentModal');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('Error updating payment', 'error');
                })
                .finally(() => {
                    // Remove loading state
                    submitButton.classList.remove('btn-loading');
                    submitButton.innerHTML = originalContent;
                });
            });

            // Modal functions
            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            function showToast(message, type) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                toastMessage.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }

            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });

            // Close modal with escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        </script>
    </main>
</body>
</html>